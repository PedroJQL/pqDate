{"version":3,"sources":["../packages/core/src/index.ts","../packages/intl/src/index.ts","../packages/rules/src/index.ts"],"sourcesContent":["// pqDate core: UTC-first, immutable operations\n\nexport type Duration = Partial<{\n  years: number; months: number; days: number; hours: number; minutes: number; seconds: number;\n}>;\n\nexport type PqErrorCode = 'E_PARSE_INVALID' | 'E_RANGE' | 'E_ARG_INVALID';\n\nexport class PqDateError extends Error {\n  public code: PqErrorCode;\n  constructor(code: PqErrorCode, message: string) {\n    super(message);\n    this.name = 'PqDateError';\n    this.code = code;\n  }\n}\n\nfunction isValidDate(d: Date): boolean {\n  return d instanceof Date && !isNaN(d.getTime());\n}\n\nexport function assertValid(d: Date): void {\n  if (!isValidDate(d)) {\n    throw new PqDateError('E_PARSE_INVALID', 'Invalid date');\n  }\n}\n\n// RF-01 parseISO: ISO 8601 input only\nexport function parseISO(input: string): Date {\n  if (typeof input !== 'string') {\n    throw new PqDateError('E_ARG_INVALID', 'parseISO expects string input');\n  }\n  // Rely on native ISO parser; reject non-ISO quickly\n  // Basic ISO shape check (YYYY-MM-DD...) to avoid locale inputs\n  if (!/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}/.test(input) && !/^\\d{4}-\\d{2}-\\d{2}$/.test(input)) {\n    throw new PqDateError('E_PARSE_INVALID', 'Input must be ISO 8601');\n  }\n  const d = new Date(input);\n  assertValid(d);\n  return new Date(d.getTime());\n}\n\n// RF-01 formatISO\nexport function formatISO(d: Date): string {\n  assertValid(d);\n  return new Date(d.getTime()).toISOString();\n}\n\nfunction daysInMonthUTC(year: number, monthIndex: number): number {\n  // monthIndex: 0..11; construct first day of next month in UTC then go one day back\n  const firstNext = Date.UTC(monthIndex === 11 ? year + 1 : year, (monthIndex + 1) % 12, 1);\n  const lastCurrent = new Date(firstNext - 24 * 3600 * 1000);\n  return lastCurrent.getUTCDate();\n}\n\nfunction clampDayUTC(year: number, monthIndex: number, day: number): number {\n  return Math.min(day, daysInMonthUTC(year, monthIndex));\n}\n\nfunction addMonthsUTC(d: Date, months: number): Date {\n  const y = d.getUTCFullYear();\n  const m = d.getUTCMonth();\n  const dt = d.getUTCDate();\n  const hh = d.getUTCHours();\n  const mm = d.getUTCMinutes();\n  const ss = d.getUTCSeconds();\n  const ms = d.getUTCMilliseconds();\n\n  const totalMonths = m + (months || 0);\n  const targetYear = y + Math.floor(totalMonths / 12);\n  const targetMonth = ((totalMonths % 12) + 12) % 12;\n  const day = clampDayUTC(targetYear, targetMonth, dt);\n  const ts = Date.UTC(targetYear, targetMonth, day, hh, mm, ss, ms);\n  return new Date(ts);\n}\n\nfunction addYearsUTC(d: Date, years: number): Date {\n  return addMonthsUTC(d, (years || 0) * 12);\n}\n\nfunction addDaysUTC(d: Date, days: number): Date {\n  const ts = d.getTime() + (days || 0) * 24 * 3600 * 1000;\n  return new Date(ts);\n}\n\nfunction addHMSUTC(d: Date, hours = 0, minutes = 0, seconds = 0): Date {\n  const delta = ((hours || 0) * 3600 + (minutes || 0) * 60 + (seconds || 0)) * 1000;\n  return new Date(d.getTime() + delta);\n}\n\n// RF-03 add\nexport function add(d: Date, dur: Duration): Date {\n  assertValid(d);\n  if (!dur || typeof dur !== 'object') {\n    throw new PqDateError('E_ARG_INVALID', 'add expects Duration');\n  }\n  let r = new Date(d.getTime());\n  if (dur.years) r = addYearsUTC(r, dur.years);\n  if (dur.months) r = addMonthsUTC(r, dur.months);\n  if (dur.days) r = addDaysUTC(r, dur.days);\n  if (dur.hours || dur.minutes || dur.seconds) {\n    r = addHMSUTC(r, dur.hours, dur.minutes, dur.seconds);\n  }\n  return r;\n}\n\n// RF-03 sub\nexport function sub(d: Date, dur: Duration): Date {\n  const negate: Duration = {};\n  if (dur?.years) negate.years = -dur.years;\n  if (dur?.months) negate.months = -dur.months;\n  if (dur?.days) negate.days = -dur.days;\n  if (dur?.hours) negate.hours = -dur.hours;\n  if (dur?.minutes) negate.minutes = -dur.minutes;\n  if (dur?.seconds) negate.seconds = -dur.seconds;\n  return add(d, negate);\n}\n\n// RF-03/04 startOf, endOf\nexport function startOf(d: Date, unit: 'day'|'month'|'year'): Date {\n  assertValid(d);\n  if (unit === 'day') {\n    return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), 0, 0, 0, 0));\n  }\n  if (unit === 'month') {\n    return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1, 0, 0, 0, 0));\n  }\n  if (unit === 'year') {\n    return new Date(Date.UTC(d.getUTCFullYear(), 0, 1, 0, 0, 0, 0));\n  }\n  throw new PqDateError('E_ARG_INVALID', 'Invalid unit');\n}\n\nexport function endOf(d: Date, unit: 'day'|'month'|'year'): Date {\n  assertValid(d);\n  if (unit === 'day') {\n    return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), 23, 59, 59, 999));\n  }\n  if (unit === 'month') {\n    const y = d.getUTCFullYear();\n    const m = d.getUTCMonth();\n    const dim = daysInMonthUTC(y, m);\n    return new Date(Date.UTC(y, m, dim, 23, 59, 59, 999));\n  }\n  if (unit === 'year') {\n    return new Date(Date.UTC(d.getUTCFullYear(), 11, 31, 23, 59, 59, 999));\n  }\n  throw new PqDateError('E_ARG_INVALID', 'Invalid unit');\n}\n\n// RF-04 comparisons\nexport function isBefore(a: Date, b: Date): boolean {\n  assertValid(a); assertValid(b);\n  return a.getTime() < b.getTime();\n}\n\nexport function isAfter(a: Date, b: Date): boolean {\n  assertValid(a); assertValid(b);\n  return a.getTime() > b.getTime();\n}\n\nexport function isWithinInterval(d: Date, itv: {start: Date; end: Date;}): boolean {\n  assertValid(d);\n  assertValid(itv?.start as Date);\n  assertValid(itv?.end as Date);\n  const start = itv.start.getTime();\n  const end = itv.end.getTime();\n  if (start > end) throw new PqDateError('E_RANGE', 'Interval start > end');\n  const t = d.getTime();\n  return t >= start && t <= end;\n}\n\n// RF-05 timezone: toLocal\n// Convert a UTC-internal Date to a Date whose local wall-time equals the original UTC components.\n// Example: 2025-01-31T00:00:00Z -> new Date(2025,0,31,0,0,0) (local time)\nexport function toLocal(dUTC: Date): Date {\n  assertValid(dUTC);\n  return new Date(\n    dUTC.getUTCFullYear(),\n    dUTC.getUTCMonth(),\n    dUTC.getUTCDate(),\n    dUTC.getUTCHours(),\n    dUTC.getUTCMinutes(),\n    dUTC.getUTCSeconds(),\n    dUTC.getUTCMilliseconds()\n  );\n}\n\n","// pqDate intl: local formatting with Intl\nimport { assertValid } from '@pqdate/core';\n\nexport type PqLocale = 'es-ES'|'en-US';\nexport type LocalFormatOptions = {\n  locale?: PqLocale;\n  dateStyle?: 'short'|'medium'|'long';\n  timeStyle?: 'short'|'medium'|'long';\n};\n\nexport function formatLocal(d: Date, opts: LocalFormatOptions = {}): string {\n  assertValid(d);\n  const { locale = 'en-US', dateStyle = 'medium', timeStyle } = opts;\n  const fmt = new Intl.DateTimeFormat(locale, {\n    dateStyle: dateStyle,\n    ...(timeStyle ? { timeStyle } : {})\n  });\n  return fmt.format(d);\n}\n\n","// pqDate rules: advanced date rules\nimport { assertValid, endOf, startOf } from '@pqdate/core';\n\n// RF-09 lastBusinessDayOfMonth: Mon-Fri, last weekday of month\nexport function lastBusinessDayOfMonth(d: Date): Date {\n  assertValid(d);\n  const monthEnd = endOf(d, 'month');\n  // move to date only (UTC 00:00)\n  let cur = startOf(monthEnd, 'day');\n  // Day of week in local? Use UTC to be consistent with UTC policy\n  // getUTCDay(): 0=Sun, 6=Sat\n  while (true) {\n    const dow = cur.getUTCDay();\n    if (dow >= 1 && dow <= 5) return cur;\n    // step back one day\n    cur = new Date(cur.getTime() - 24 * 3600 * 1000);\n  }\n}\n\n"],"mappings":"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","names":["PqDateError","code","message","__publicField","isValidDate","d","assertValid","parseISO","input","formatISO","daysInMonthUTC","year","monthIndex","firstNext","clampDayUTC","day","addMonthsUTC","months","y","m","dt","hh","mm","ss","ms","totalMonths","targetYear","targetMonth","ts","addYearsUTC","years","addDaysUTC","days","addHMSUTC","hours","minutes","seconds","delta","add","dur","r","sub","negate","startOf","unit","endOf","dim","isBefore","a","b","isAfter","isWithinInterval","itv","start","end","t","toLocal","dUTC","formatLocal","d","opts","assertValid","locale","dateStyle","timeStyle","lastBusinessDayOfMonth","d","assertValid","monthEnd","endOf","cur","startOf","dow"]}